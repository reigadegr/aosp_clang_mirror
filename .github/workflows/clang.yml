name: Update Clang Prebuilts

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
  # schedule:
    # - cron: '0 */3 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Dependencies
        run: sudo apt update && sudo apt install -qq aria2 git jq

      - name: Fetch latest Clang info
        id: fetch-latest
        env:
          AOSP_REPO: "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/mirror-goog-main-llvm-toolchain-source"
        run: |
          LATEST_CLANG=$(curl -s "$AOSP_REPO" \
            | grep -oP 'href="[^"]*clang-r[0-9]+[a-z]?/' \
            | grep -oP 'clang-r[0-9]+[a-z]?' \
            | sort -V \
            | tail -n1)
          BUILD_ID=$(curl -fsSL \
            "${AOSP_REPO}/${LATEST_CLANG}/BUILD_INFO?format=TEXT" \
            | base64 -d \
            | jq -r .bid)
          CLANG_VERSION=$(curl -fsSL \
            "${AOSP_REPO}/${LATEST_CLANG}/AndroidVersion.txt?format=TEXT" \
            | base64 -d \
            | head -n1)

          echo "latest_clang=$LATEST_CLANG" >> "$GITHUB_OUTPUT"
          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"
          echo "clang_version=$CLANG_VERSION" >> "$GITHUB_OUTPUT"
          echo "new_tag=${LATEST_CLANG}-${BUILD_ID}" >> "$GITHUB_OUTPUT"

      - name: Check if release/tag exists
        id: exists
        run: |
          TAG="${{ steps.fetch-latest.outputs.new_tag }}"
          if git tag --list "$TAG" | grep -q .; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Clang release exists
        if: steps.exists.outputs.exists == 'true'
        run: echo "Latest Clang ${{ steps.fetch-latest.outputs.new_tag }} is already released."

      - name: Download Clang
        if: steps.exists.outputs.exists == 'false'
        env:
          AOSP_ARCHIVE: "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/mirror-goog-main-llvm-toolchain-source"
        run: |
          WORKSPACE="toolchain"
          FILE="${{ steps.fetch-latest.outputs.latest_clang }}.tar.gz"
          URL="${AOSP_ARCHIVE}/${{ steps.fetch-latest.outputs.latest_clang }}.tar.gz?format=tar.gz"

          mkdir -p "$WORKSPACE"

          attempt=0
          retries=5
          aria_opts=(
            -q -c -x16 -s16 -k8M
            --file-allocation=falloc --check-certificate=false
            -d "$WORKSPACE" -o "$FILE" "$URL"
          )

          while (( attempt < retries )); do
            if aria2c "${aria_opts[@]}"; then
              echo "Clang download successful!"
              break
            else
              echo "Clang download attempt $(( attempt + 1 )) failed, retrying..."
              (( attempt++ ))
              sleep 5
            fi
          done

          if (( attempt == retries )); then
            echo "Clang download failed after $retries attempts!"
            exit 1
          fi

      - name: Create or update GitHub Release
        if: steps.exists.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: ${{ steps.fetch-latest.outputs.new_tag }}
          name: Clang prebuilts ${{ steps.fetch-latest.outputs.new_tag }}
          files: toolchain/${{ steps.fetch-latest.outputs.latest_clang }}.tar.gz
